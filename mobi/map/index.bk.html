<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Test</title>
  <link rel="stylesheet" href="themes/base/jquery-ui.css">
  <!----
  <link rel="stylesheet" href="/resources/demos/style.css">
  -->
  <script src="jquery-3.2.1.min.js"></script>
  <script src="jquery-ui.min.js"></script>
  <script>
  //$( function() {
  //  $( "#datepicker" ).datepicker();
  //} );
  </script>
</head>
<body>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #view_map {
        width: 100%;
        height: 100%;
      }
      #map {
        height: 100%;
      }
      #popup {
        position:absolute;
        display:hidden;
        top:0%;
        left:0%;
        width:200px;
        height:200px;
        #margin-top:-263px;
        #margin-left:-200px;
        background-color:#fff;
        z-index:2;
        padding:0px;
    }
    </style>
<!--
<div id="datepicker"></div>
-->
<div id="popup"><div id="datepicker"></div></div>

<div id="view_map" class="view_map">
<div id="map" class="map"></div>
</div>
<script>
$("#datepicker").datepicker({
    beforeShow: function(){    
      $("#datepicker").css('{ font-size:10px; }');
    },
    dateFormat: 'yymmdd',
    onSelect: function() {
      // Generates a GET with the URL
      process($(this).val());
    }
});
function initMap(){
  console.log("test");
}


// var filename = 'traces.a9f91b3c-8cd9-411c-a06e-451b8205f9a6.20170712.csv';


// Process the file according to the Date
function process(Date) {
  var parameters = new URLSearchParams(window.location.search);
  console.log(parameters);
  
  if(parameters.has('device')) {
    console.log(parameters.get('device'));
    var device = parameters.get('device');
    
    // Search for a date
    var filename = ''
    if(Date !== '') {
      filename = 'traces.' + device + '.' + Date + '.gps.wifi.30.250.poi.csv';
      // read the file
      console.log(Date);
    }
    else{
      if(parameters.has('date')) {
        var date = parameters.get('date');
        
        // Date must have format YYYYDDMM
        // Build the name of the file:
        filename = 'traces.' + device + '.' + date + '.gps.wifi.30.250.poi.csv';
        // read the file
        
      }
      else {
        // Delete the map region
        
      }
    }
    
    // Process the filename
    // read the file with a jquery $.get 
    if(filename != '') {
      // Read the file and draw the map
      $.get('../data/' + filename, function(content) {
        var lines = content.split("\n");
        // console.log(lines);
        var traces = new Array();
        for(var line_number in lines) {
          var fields = lines[line_number].split(",");
          // console.log(lines[line_number]);
         
          var trace = new Object();
          // Index 0: Timestamp
          // Index 1: Latitude
          // Index 2: Longitude
          // Index 3: Type {'gps': GPS, 'wifi': Wifi, 'poi': POI}
          // From index 4 and so on: depends on type
          
          if(typeof fields === 'object') {
            // console.log(fields);
            if(typeof fields[1] !== 'undefined') {
              trace.latitude = fields[1]
            }
            if(typeof fields[2] !== 'undefined') {
              trace.longitude = fields[2]
            }
            if(typeof fields[3] !== 'undefined') {
              trace.type = fields[3]
            }
            if(typeof fields[0] !== 'undefined') {
              trace.timestamp = fields[0]
            }
            
            // This depends only on type
            // if gps f1: latitude, f2: speed
            // if poi f1: duration, f2: number of records
            trace.f1 = '';
            trace.f2 = '';
            if(typeof fields[4] !== 'undefined') {
              trace.f1 = fields[4]
            }
            if(typeof fields[5] !== 'undefined') {
              trace.f2 = fields[5]
            }

            if(typeof trace.latitude !== 'undefined') {
              traces.push(trace);
            }
          }
        }
        // console.log(traces);
        $(document).data('Traces', traces);
        
        // Draw the map
        if (traces.length > 0){
          $("#view_map").empty();
          $("#view_map").append('<div id="map" class="map"></div>');
          
          if (traces.length) {
            // console.log(traces);
            drawMap(traces);
          }
        }
        // Redraw the datepicker control
        drawDatePicker(Date);
      }).fail(function() {
          // Delete the contect of the map
          $("#view_map").empty();
        });
    }
  }
}


// Draw the date picker
function drawDatePicker(Date){
  $("#popup").empty();
  $("#popup").append('<div id="datepicker" class="datepicker"></div>');
  $("#datepicker").datepicker({
    beforeShow: function(){    
      $("#datepicker").css('{ font-size:10px; }');
    },
    dateFormat: 'yymmdd',
    onSelect: function() {
      // Generates a GET with the URL
      process($(this).val());
    }    
  });
  $("#datepicker").datepicker("setDate", Date);
}


// Calculates the distance
function distance(latitude1, longitude1, latitude2, longitude2){
  var earthRadius = 6371;
  var lat1 = latitude1 * (Math.PI/180);
  var lat2 = latitude2 * (Math.PI/180);
  var dLat = Math.abs(latitude2 - latitude1) * (Math.PI/180);
  var dLng = Math.abs(longitude2 - longitude1) * (Math.PI/180);
  var a = (Math.sin(dLat / 2) * Math.sin(dLat / 2)) + 
          Math.cos(latitude1) * Math.cos(latitude2) +
          (Math.sin(dLng / 2) * Math.sin(dLng / 2));
  var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  dist = earthRadius * c;
  return dist;
}

// Attach a marker to an event to display the infowindow
function attachMessageToMarker(Marker, Message) {
  if(Message != ''){
    var infowindow = new google.maps.InfoWindow({
      content: Message
    });
    google.maps.event.addListener(Marker, 'click', function() {
      infowindow.setPosition(Marker.getPosition());
      // infowindow.open(Marker.get('map'));
      infowindow.open(Marker.getMap());
    });
    google.maps.event.addListener(Marker, 'mouseout', function() {
      infowindow.setMap(null);
    });    
  }
}

// Draw the map
function drawMap(Traces) {
  var centroid_latitude = 0;
  var centroid_longitude = 0;
  var n_points = Traces.length;
  
  for(var index in Traces) {
    centroid_latitude += parseFloat(Traces[index].latitude);
    centroid_longitude += parseFloat(Traces[index].longitude);
  }
  // console.log(centroid_latitude);
  if (n_points >= 0){
    centroid_latitude = centroid_latitude / n_points;
    centroid_longitude = centroid_longitude / n_points;
  }

  var map = new google.maps.Map(document.getElementById('map'), {
			zoom: 13,
			center: {lat: centroid_latitude, lng: centroid_longitude},
  //    center: {lat: 45.7848013, lng: 4.873656299999999},
      draggable: true,
			mapTypeId: 'terrain'
	});
  
  drawTraces(Traces, map);
}

// Draw the traces of the trajectory
function drawTraces(Traces, Map) {
  var points = new Array();
  var line = new Array();
  var total_distance = 0;
  var total_time = 0;
  var start_timestamp = 0;
  var stop_timestamp = 0;
  
  if(Traces.length) {
    start_timestamp = Traces[0];
    stop_timestamp = Traces[Traces.length - 1];
    total_time = stop_timestamp - start_timestamp
  }
  
  for(var index in Traces) {
    var latitude = parseFloat(Traces[index].latitude);
    var longitude = parseFloat(Traces[index].longitude);
    var ltln = new google.maps.LatLng(latitude, longitude);
    line.push(ltln);
    
    var icon = '';
    var msg = '';
    // Convert timestamp to Date
    var date = new Date(parseInt(Traces[index].timestamp) * 1000);
    
    if(Traces[index].type == 'gps') {
      icon = 'http://maps.google.com/mapfiles/ms/micons/red-dot.png';
      msg = '<h4>GPS<br>Altitude: ' + Traces[index].f1 
          + '<br>Speed: ' + Traces[index].f2
          + '<br>Date: ' + date.toUTCString()
    }
    else {
      if(Traces[index].type == 'wifi') {
        icon = 'http://maps.google.com/mapfiles/ms/micons/blue-dot.png';
        msg = '<h4>Wifi' 
            + '<br>Date: ' + date.toUTCString()
      }
      else {
        icon = 'http://maps.google.com/mapfiles/ms/micons/green-dot.png';
        msg = '<h4>POI<br>Duration: ' + Traces[index].f1 
            + ' minutes<br>Records: ' + Traces[index].f2
            + '<br>Date: ' + date.toUTCString()
        // In the case of the POI, add a circle for the radius
        var circle = new google.maps.Circle({
								strokeColor: '#4286f4',
								strokeOpacity: 0.8,
								strokeWeight: 2,
								fillColor: '#41f4b2',
								fillOpacity: 0.25,
								map: Map,
								center: ltln,
								radius: 250,  // POI of 250 mts
								zIndex: 4
							});
      }
    }
   
    // Add Marker
    var marker = new google.maps.Marker({
      position: ltln,
      icon: icon,
      map: Map
    });
    // Add Info Window
    attachMessageToMarker(marker, msg);
  }
  // console.log(line);
  if (line.length > 0) {
    var path = new google.maps.Polyline({
      path: line,
      geodesic: true,
      strokeColor: '#FF0000',
      strokeOpacity: 1.0,
      strokeWeight: 2
    });
    path.setMap(Map);
  }
}

// Call the main processing function
// I think it is better to put it in initMap
// because of the asynchronous call from google api
process('');
</script> 
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAs7foiRxJv66M3niPPlzGHGaMF09_i74M&callback=initMap&libraries=places" async defer></script> 
</body>
</html>